---
id: nextjs-tutorial
sidebar_position: 2
keywords: [TypeScript, temporal, sdk, tutorial, NextJS]
tags: [TypeScript, SDK]
last_update:
  date: 2024-06-04
title: Build a full-stack one-click order app with Next.js and Temporal
description: Build a One-Click Buy application with Next.js and integrate Temporal using Next.js API routes to create a durable order processing backend.
image: /img/temporal-logo-twitter-card.png
---

![Temporal TypeScript SDK](/img/sdk_banners/banner_typescript.png)

### Introduction

When you're building an e-commerce application, you want to provide customers withj a great user experience. You alsoneed to ensure that any calls to external services, like databases, payment gateways, and other tools, are reliable.
You can deliver a greate experience across the stack  by integrating a Temporal Workflow with Next.js.

[Next.js](https://nextjs.org/) is a popular choice for building full-stack web applications using Node.js and React.
In this tutorial you'll integrate a Temporal Workflow into a Next.js application. You'll build a backend API using Nest API Routes that starts a Temporal Workflow, and then build a quick user interface with React and Tailwind to call that API. When you're done, you'll have a framework you can follow for building full-stack web applications powered by Temporal.

## Prerequisites

Before starting this tutorial:

- [Set up a local development environment for developing Temporal applications using TypeScript](/getting_started/typescript/dev_environment/index.md)
- Review the [Hello World in TypeScript tutorial](/getting_started/typescript/hello_world_in_typescript/index.md) to understand the basics of getting a Temporal TypeScript SDK project up and running.

## Create your project

You'll use the Next.js project generator to create a basic Next.js application.
Then you'll configure dependencies for the project and set up a Temporal project within the Next.js application.

Create a new Next.js project with the `create-next-app` tool. Call the project `nextjs-temporal`:

```command
npx create-next-app@latest nextjs-temporal
```

The project generator will prompt you with several questions; accept all of the default values.
When the project generator completes, and the dependencies install, switch to the new project's root directory;

```command
cd nextjs-temporal
```

Install the `@tsconfig/node20` package as a developer dependency, as you'll use it as the foundation for a Temporal-specific `tsconfig` file you'll keep separate from the one generated by the Next.js project generator:

```command
npm install --save-dev @tsconfig/node20
```

Next, install [Nodemon](https://nodemon.io/) which you'll use to watch your files for changes and reload Temporal Workers:

```command
npm install --save-dev @tsconfig/node20
```

With the dependencies installed, you can add Temporal to the project.

In the root directory of your Next.js project, execute the following command to install Temporal and its dependencies:

```command
npm install @temporalio/client @temporalio/worker @temporalio/workflow @temporalio/activity
```

Now create a directory to hold your Temporal Workflows and Activities:

```command
mkdir -p temporal/src
```

Configure TypeScript to compile from `temporal/src` to `temporal/lib` by adding a new `tsconfig.json` in the `temporal/src` folder:

```command
touch temporal/tsconfig.json
```

Add the following configuration to the file:

```json
{
  "extends": "@tsconfig/node20/tsconfig.json",
  "version": "4.4.2",
  "compilerOptions": {
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "rootDir": "./src",
    "outDir": "./lib"
  },
  "include": ["src/**/*.ts"]
}
```

For convenience, set up some scripts to run the builds in your project root's `package.json`.

Add the `npm-run-all` command to your project as a dependency:

```command
npm install npm-run-all --save-dev
```

Then use `npm-run-all` to define scripts to run your Temporal build processes and run the Next.JS app alongside Temporal Workers.

Locate your existing `scripts` section, which defines  scripts to run and build Next.js applications:

```json
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
```

Change the scripts so you can build and run your Next.js application and your Temporal Workers at the same time:

```json
  "scripts": {
    "dev": "npm-run-all -l build:temporal --parallel dev:temporal dev:next start:worker",
    "dev:next": "next dev",
    "dev:temporal": "tsc --build --watch ./temporal/tsconfig.json",
    "build:next": "next build",
    "build:temporal": "tsc --build ./temporal/tsconfig.json",
    "start:worker": "nodemon ./temporal/lib/worker",
    "start": "next start",
    "lint": "eslint ."
  },
```

These scripts let you run the following steps with a single `npm run dev` command:

- build Temporal once.
- start Next.js locally.
- start a Temporal Worker.
- rebuild Temporal files when they change.

With your project configured, you can write your Temporal Workflows and Activities.

## Define the business logic using Temporal

You'll use Temporal to power a one-click ordering process.
Each order will be represented by a Temporal Workflow, which orchestrates one or more Activities.

[Activities](https://docs.temporal.io/activities) are how you interact with the outside world in Temporal.
You use them to make API requests, access the filesystem, or perform other non-deterministic operations.

The Workflow you'll create in this tutorial will have a single Activity, `purchase`.

Create the file `temporal/src/activities.ts`:

```command
touch temporal/src/activities.ts
```

Inside of `temporal/src/activities.ts`, add the following code to define the `purchase` function:

<!--SNIPSTART typescript-next-oneclick-activities -->
[temporal/src/activities.ts](https://github.com/temporalio/nextjs-temporal-one-click-template/blob/next-v2/temporal/src/activities.ts)
```ts
import { Context } from '@temporalio/activity';

export async function purchase(id: string): Promise<string> {
  console.log(`Purchased ${id}!`);
  return Context.current().info.activityId;
}
```
<!--SNIPEND-->

In a real application, this function would interact with a payment API and attempt to make a payment.
For this tutorial, the function prints a message to the console and returns the ID of the Activity.

Now define the `order` Workflow that calls this Activity.
Create the file `temporal/src/workflows.ts`:

```command
touch temporal/src/workflows.ts
```

Add the following code to `temporal/src/workflows.ts` to define the Workflow:

<!--SNIPSTART typescript-next-oneclick-workflows -->
[temporal/src/workflows.ts](https://github.com/temporalio/nextjs-temporal-one-click-template/blob/next-v2/temporal/src/workflows.ts)
```ts
import { proxyActivities, sleep } from '@temporalio/workflow';
import type * as activities from './activities';

const { purchase } = proxyActivities<typeof activities>({
  startToCloseTimeout: '1 minute',
});

export async function OneClickBuy(id: string): Promise<string> {
  const result = await purchase(id); // calling the activity
  await sleep('10 seconds'); // sleep to simulate a longer response.
  console.log(`Activity ID: ${result} executed!`);
  return result;
}
```
<!--SNIPEND-->

Workflow code is bundled and run inside a [deterministic v8 isolate](https://docs.temporal.io/typescript/determinism) so you can persist and replay every state change.
This is why Workflow code must be separate from Activity code, and why you have to `proxyActivities` instead of directly importing them.

With your Workflows and Activities in place, you can now write a [Worker Program](https://docs.temporal.io/workers#worker-program).
You use a Worker Program to define a [Worker](https://docs.temporal.io/workers) which hosts your Activies and Workflows and polls the `ecommerce-oneclick` Task Queue to look for work to do.

You'll need to use the Task Queue name in your Worker Program as well as any time you interact with a Workflow from your Next.js application. To ensure you use it consistently, create a constant.

Create the file `temporal/src/shared.ts`:

```command
touch temporal/src/shared.ts
```

Add the following line to the file to define the constant:

<!--SNIPSTART typescript-next-oneclick-shared -->
[temporal/src/shared.ts](https://github.com/temporalio/nextjs-temporal-one-click-template/blob/next-v2/temporal/src/shared.ts)
```ts
export const TASK_QUEUE_NAME = 'ecommerce-oneclick';
```
<!--SNIPEND-->

Now define the Worker program. Create `temporal/src/worker.ts`:

```command
touch temporal/src/worker.ts
```

In `temporal/src/worker.ts`, define the Worker Program:

<!--SNIPSTART typescript-next-oneclick-worker -->
[temporal/src/worker.ts](https://github.com/temporalio/nextjs-temporal-one-click-template/blob/next-v2/temporal/src/worker.ts)
```ts
import { NativeConnection, Worker } from '@temporalio/worker';
import * as activities from './activities';
import { TASK_QUEUE_NAME } from './shared';

run().catch((err) => console.log(err));

async function run() {
  const connection = await NativeConnection.connect({
    address: 'localhost:7233',
    // In production, pass options to configure TLS and other settings.
  });
  try {
    const worker = await Worker.create({
      connection,
      workflowsPath: require.resolve('./workflows'),
      activities,
      taskQueue: TASK_QUEUE_NAME
    });
    await worker.run();
  } finally {
    connection.close();
  }
}
```
<!--SNIPEND-->

When the Worker finds [Workflow Tasks](https://docs.temporal.io/workers#workflow-task) or [Activity Tasks](https://docs.temporal.io/workers#activity-task) for the Workflows and Activities it hosts, it executes them.

Run your Worker with the following command to ensure that everything builds properly and there are no errors:

```command
npm run build:temporal && npm run start:worker`
```

The Worker runs, but it won't have any tasks to perform because you haven't started a Workflow yet. Stop the Worker with `CTRL+C`.

Next you'll make a Next.js API route that starts a Temporal Workflow.

## Write a Temporal Client inside a Next.js API Route

You'll use Next.js API routes to expose a serverless endpoint that your frontend can call and then communicate with Temporal on the backend.

You don't want to create a new Temporal Client on every API request, so create a function that creates a new Temporal Client or returns the existing one. In `temporal/src` add a new file called `client.ts`:

```command
touch temporal/src/client.ts
```

Add the following code to `temporal/src/client.ts` to define a `makeClient` function that creates the client, and a `getTemporalClient` function that retrives it:

<!--SNIPSTART typescript-next-oneclick-client -->
[temporal/src/client.ts](https://github.com/temporalio/nextjs-temporal-one-click-template/blob/next-v2/temporal/src/client.ts)
```ts
import { Client, Connection } from '@temporalio/client';

const client: Client = makeClient();

function makeClient(): Client {
  const connection = Connection.lazy({
    address: 'localhost:7233',
    // In production, pass options to configure TLS and other settings.
  });
  return new Client({ connection });
}

export function getTemporalClient(): Client {
  return client;
}
```
<!--SNIPEND-->

You'll use the `getTemporalClient` function in your Next.js application any time you need to interact with Temporal.

Now build out the API route to purchase an item. In the root of your application, add a new `app/api/startBuy` folder:

```command
mkdir -p app/api/startBuy
```

Then create the file `app/api/startBuy/route.ts`:

```command
touch app/api/startBuy/route.ts
```

Within the file, create a `POST` route that fetches a Temporal Client and uses it to start a [Workflow Execution](https://docs.temporal.io/workflows#workflow-execution):

<!--SNIPSTART typescript-next-oneclick-api -->
[app/api/startBuy/route.ts](https://github.com/temporalio/nextjs-temporal-one-click-template/blob/next-v2/app/api/startBuy/route.ts)
```ts
import { OneClickBuy } from '../../../temporal/src/workflows';
import { getTemporalClient } from '../../../temporal/src/client';
import { TASK_QUEUE_NAME } from '../../../temporal/src/shared';

export async function POST(req: Request) {
  interface RequestBody {
    itemId: string;
    transactionId: string;
  }

  let body: RequestBody;

  try {
    body = await req.json() as RequestBody;
  } catch (error) {
    return new Response("Invalid JSON body", { status: 400 });
  }

  const { itemId, transactionId } = body;

  if (!itemId) {
    return new Response("Must send the itemID to buy", { status: 405 });
  }

  await getTemporalClient().workflow.start(OneClickBuy, {
    taskQueue: TASK_QUEUE_NAME,
    workflowId: transactionId,
    args: [itemId],
  });

  return Response.json({ ok: true });
}
```
<!--SNIPEND-->

Ensure all of your files are saved.

Now start Next.js and the Temporal worker using the `npm run dev` script you defined:

```command
npm run dev
```

In another terminal window, use the `curl` command to make a request to the API endpoint, which starts the Temporal Workflow:

```command
curl -d '{"itemId":"1", "transactionId":"abc123"}' \
     -H "Content-Type: application/json" \
     -X POST http://localhost:3000/api/startBuy
```

The terminal that's running your application and Temporal Worker will print `Purchased 1`:

```output
[dev:next    ]  POST /api/startBuy 200 in 16ms
[start:worker] Purchased 1!
```

Now that you know the API works, you can build the front end user interface.

## Build the front-end interface

You can call your Next.js API with `curl`, but that's not the idea user interface. With Next.js, you

To call the API Route from the Next.js frontend, you'd use the `fetch` API to make a request o the `/api/startbuy` method using a similar payload when you click a button.

Build out the front-end user interface. Open `app/page.tsx` and remove its contents. Then at the top, add the following code to import the necessary libraries:

<!--SNIPSTART typescript-next-oneclick-page-start -->
[app/page.tsx](https://github.com/temporalio/nextjs-temporal-one-click-template/blob/next-v2/app/page.tsx)
```tsx
'use client'
import Head from 'next/head';
import React from 'react';
import { v4 as uuid4 } from 'uuid';
import 'react-toastify/dist/ReactToastify.css';
```
<!--SNIPEND-->

Next, define an interface for the Product's properties, a Type to define states for the purchase, and a collection of Products:

<!--SNIPSTART typescript-next-oneclick-page-vars -->
[app/page.tsx](https://github.com/temporalio/nextjs-temporal-one-click-template/blob/next-v2/app/page.tsx)
```tsx

interface ProductProps {
  product: {
    id: number;
    name: string;
    price: string;
  };
}

const products = [
  {
    id: 1,
    name: 'PDF Book',
    price: '$49',
  },
  {
    id: 2,
    name: 'Kindle Book',
    price: '$49',
  },
];

type ITEMSTATE = 'NEW' |  'ORDERED' | 'ERROR';
```
<!--SNIPEND-->

In a production application, your products would come from another part of your application, such as a database or a Shopify store.

Next, define a Product component with the following code:

<!--SNIPSTART typescript-next-oneclick-page-product -->
[app/page.tsx](https://github.com/temporalio/nextjs-temporal-one-click-template/blob/next-v2/app/page.tsx)
```tsx
const Product: React.FC<ProductProps> = ({ product }) => {
  const itemId = product.id;
  const [state, setState] = React.useState<ITEMSTATE>('NEW');
  const stateRef = React.useRef<ITEMSTATE>();
  stateRef.current = state;

  const [transactionId, setTransactionId] = React.useState(uuid4());

  const buyProduct = () => {
    fetch('/api/startBuy', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ itemId, transactionId }),
    })
      .then(() => {
        setState('ORDERED');
      })
      .catch(() => {
        setState('ERROR');
      });
  };

  const buyStyle = "w-full bg-white hover:bg-blue-200 bg-opacity-75 backdrop-filter backdrop-blur py-2 px-4 rounded-md text-sm font-medium text-gray-900 text-center";
  const orderStyle = "w-full bg-green-500 bg-opacity-75 backdrop-filter backdrop-blur py-2 px-4 rounded-md text-sm font-medium text-gray-900 text-center";
  const errorStyle = "w-full bg-white hover:bg-blue-200 bg-opacity-75 backdrop-filter backdrop-blur py-2 px-4 rounded-md text-sm font-medium text-gray-900 text-center";

  return (
    <div key={product.id} className="relative group">
      <div className="aspect-w-4 aspect-h-3 rounded-lg overflow-hidden bg-gray-100">
        <div className="flex items-end p-4" aria-hidden="true">
          {
            {
              NEW:     ( <button onClick={buyProduct} className={buyStyle}> Buy Now </button> ),
              ORDERED: ( <div className={orderStyle}>Ordered</div> ),
              ERROR:   ( <button onClick={buyProduct} className={errorStyle}>Error! Click to Retry </button> ),
            }[state]
          }
        </div>
      </div>
      <div className="mt-4 flex items-center justify-between text-base font-medium text-gray-900 space-x-8">
        <h3>{product.name}</h3>
        <p>{product.price}</p>
      </div>
    </div>
  );
};
```
<!--SNIPEND-->

In this component, the `buyProduct` function makes the call to start the Temporal Workflow by making a request to the API route you defined.
The component renders the product and displays a button for the customer to click. Based on the order state,
the button is replaced with a confirmation message or a button that lets the customer try again if there's an error.

Now add a `ProductList` component with the following code:

<!--SNIPSTART typescript-next-oneclick-page-productlist -->
[app/page.tsx](https://github.com/temporalio/nextjs-temporal-one-click-template/blob/next-v2/app/page.tsx)
```tsx
const ProductList: React.FC = () => {
  return (
    <div className="bg-white">
      <div className="max-w-2xl mx-auto py-16 px-4 sm:py-24 sm:px-6 lg:max-w-7xl lg:px-8">
        <div className="mt-6 grid grid-cols-1 gap-x-8 gap-y-8 sm:grid-cols-2 sm:gap-y-10 md:grid-cols-4">
          {products.map((product) => (
            <Product product={product} key={product.id} />
          ))}
        </div>
      </div>
    </div>
  );
};
```
<!--SNIPEND-->

Finally, add the `Home` component to define the overall header and render the product list:

<!--SNIPSTART typescript-next-oneclick-page-home -->
[app/page.tsx](https://github.com/temporalio/nextjs-temporal-one-click-template/blob/next-v2/app/page.tsx)
```tsx
const Home: React.FC = () => {
  return (
    <div className="pt-8 pb-80 sm:pt-12 sm:pb-40 lg:pt-24 lg:pb-48">
      <div className="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 sm:static">
        <Head>
          <title>Temporal + Next.js Example</title>
          <link rel="icon" href="/favicon.ico" />
        </Head>
        <header className="relative overflow-hidden">
          <div className="sm:max-w-lg">
            <h1 className="text-4xl font font-extrabold tracking-tight text-gray-900 sm:text-6xl">
              Temporal.io + Next.js One Click Purchase Demo
            </h1>
            <p className="mt-4 text-xl text-gray-500">
              Click on the item to buy it now.
            </p>
          </div>
        </header>
        <ProductList />
      </div>
    </div>
  );
};

export default Home;
```
<!--SNIPEND-->

Visit `http://localhost:3000` in your browser and you'll see two products. Click their buttons and you'll execute the Temporal Workflows.

You now have a Next.js application that uses Temporal Workflows to power one of its backend processes.


When you're moving from your local machine to either [Temporal Cloud](https:temporal.io/cloud) or a self-hosted Temporal Service, you'll need to configure Temporal Clients and Temporal Workers to communicate with the remote service.
To connect to a Temporal Service using mTLS authentication, you will need to configure the connection address, namespace, and mTLS certificates and keys.

Reeview [Run Workers with Temporal Cloud for the TypeScript SDK](run-workers-with-cloud-typescript) for more details on creating certificates and connecting to Temporal Cloud.

In this application, you'd modify `temporal/src/worker.ts` to add certificate information:

```ts
const connection = await NativeConnection.connect({
  address,
  tls: {
    clientCertPair: {
      crt: fs.readFileSync(clientCertPath),
      key: fs.readFileSync(clientKeyPath),
    },
  },
});
```

Then you'd modify the `makeClient` function in `temporal/src/client.ts` to incldue the same keys:

```ts
function makeClient(): Client {
  const connection = Connection.lazy({
    address: 'localhost:7233',
    tls: {
      clientCertPair: {
        crt: fs.readFileSync(clientCertPath),
        key: fs.readFileSync(clientKeyPath),
      },
    },
  });
  return new Client({ connection });
}
```

Restart your application to establish the connections to the new Temporal Service.

## Conclusion

At this point, you have a working full stack example of a Temporal Workflow running inside your Next.js app, and the beginnings of an order processing system.
From here you can add additional Activities to the Workflow, or use this project as the basis for a different kind of application that needs long-running processes.

You can also explore adding [Signals](https://docs.temporal.io/dev-guide/typescript/features//#signals) or  [Queries](https://docs.temporal.io/dev-guide/typescript/features//#queries) to your Workflow and
map those to new API routes.

For a more detailed example, look at the Next.js E-Commerce One-Click example in the [samples-typescript repo](https://github.com/temporalio/samples-typescript/tree/main/nextjs-ecommerce-oneclick).

You can deploy your Next.js app, including Next.js API Routes with Temporal Clients in them, anywhere you can deploy Next.js applications, including in serverless environments like Vercel or Netlify. However, you **must deploy your Temporal Workers in traditional environments**, such as EC2, DigitalOcean, or Render. They won't work in a serverless environment.

As you move into production with your app, please review the following documentation.

- [Securing](https://docs.temporal.io/typescript/security)
- [Testing](https://docs.temporal.io/typescript/testing)
- [Patching](https://docs.temporal.io/typescript/patching) (aka migrating code to new versions)
- [Logging](https://docs.temporal.io/typescript/logging)
- [Production Deploy Checklist](https://docs.temporal.io/typescript/production-deploy)

You will also want to have a plan for **monitoring and scaling your Temporal Workers** that host and execute your Activity and Workflow code (separately from monitoring and scaling Temporal Server itself).
